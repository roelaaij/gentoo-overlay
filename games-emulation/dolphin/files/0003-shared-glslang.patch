From fa02e8438f4818cdfbf835030df9d039418fbec1 Mon Sep 17 00:00:00 2001
From: Roel Aaij <roel.aaij@gmail.com>
Date: Sat, 27 Sep 2025 21:19:03 +0200
Subject: [PATCH] shared glslang

---
 .../Core/VideoBackends/Vulkan/CMakeLists.txt  |   4 +-
 Source/Core/VideoCommon/CMakeLists.txt        |  14 +-
 Source/Core/VideoCommon/Spirv.cpp             | 123 +-----------------
 Source/Core/VideoCommon/Spirv.h               |   2 +-
 4 files changed, 11 insertions(+), 132 deletions(-)

diff --git a/Source/Core/VideoBackends/Vulkan/CMakeLists.txt b/Source/Core/VideoBackends/Vulkan/CMakeLists.txt
index c4fbd847e1..dc9e2ec466 100644
--- a/Source/Core/VideoBackends/Vulkan/CMakeLists.txt
+++ b/Source/Core/VideoBackends/Vulkan/CMakeLists.txt
@@ -39,7 +39,9 @@ add_library(videovulkan
 
 target_link_libraries(videovulkan
 PUBLIC
-  common
+  glslang::glslang
+  glslang::SPIRV
+  glslang::glslang-default-resource-limits
   videocommon
 
 PRIVATE
diff --git a/Source/Core/VideoCommon/CMakeLists.txt b/Source/Core/VideoCommon/CMakeLists.txt
index 0ead1af2f8..172c3ee9fb 100644
--- a/Source/Core/VideoCommon/CMakeLists.txt
+++ b/Source/Core/VideoCommon/CMakeLists.txt
@@ -224,7 +224,9 @@ PRIVATE
   xxhash::xxhash
   imgui
   implot
-  glslang
+  glslang::glslang
+  glslang::SPIRV
+  glslang::glslang-default-resource-limits
   tinygltf
 )
 
@@ -267,16 +269,6 @@ if(FFmpeg_FOUND)
   endif()
 endif()
 
-# Silence warnings on glslang by flagging it as a system include
-target_include_directories(videocommon
-SYSTEM PUBLIC
-  ${CMAKE_SOURCE_DIR}/Externals/glslang/glslang/glslang/Public
-SYSTEM PRIVATE
-  ${CMAKE_SOURCE_DIR}/Externals/glslang/glslang/glslang
-  ${CMAKE_SOURCE_DIR}/Externals/glslang/glslang/SPIRV
-  ${CMAKE_SOURCE_DIR}/Externals/glslang/glslang
-)
-
 if(MSVC)
   # Add precompiled header
   target_link_libraries(videocommon PRIVATE use_pch)
diff --git a/Source/Core/VideoCommon/Spirv.cpp b/Source/Core/VideoCommon/Spirv.cpp
index 1ee3d6da2d..4eee3441e9 100644
--- a/Source/Core/VideoCommon/Spirv.cpp
+++ b/Source/Core/VideoCommon/Spirv.cpp
@@ -4,8 +4,9 @@
 #include "VideoCommon/Spirv.h"
 
 // glslang includes
-#include "GlslangToSpv.h"
-#include "disassemble.h"
+#include "glslang/SPIRV/GlslangToSpv.h"
+#include "glslang/SPIRV/disassemble.h"
+#include "glslang/Public/ResourceLimits.h"
 
 #include "Common/FileUtil.h"
 #include "Common/Logging/Log.h"
@@ -38,123 +39,7 @@ bool InitializeGlslang()
 
 const TBuiltInResource* GetCompilerResourceLimits()
 {
-  static const TBuiltInResource default_resource = {
-      /* .MaxLights = */ 32,
-      /* .MaxClipPlanes = */ 6,
-      /* .MaxTextureUnits = */ 32,
-      /* .MaxTextureCoords = */ 32,
-      /* .MaxVertexAttribs = */ 64,
-      /* .MaxVertexUniformComponents = */ 4096,
-      /* .MaxVaryingFloats = */ 64,
-      /* .MaxVertexTextureImageUnits = */ 32,
-      /* .MaxCombinedTextureImageUnits = */ 80,
-      /* .MaxTextureImageUnits = */ 32,
-      /* .MaxFragmentUniformComponents = */ 4096,
-      /* .MaxDrawBuffers = */ 32,
-      /* .MaxVertexUniformVectors = */ 128,
-      /* .MaxVaryingVectors = */ 8,
-      /* .MaxFragmentUniformVectors = */ 16,
-      /* .MaxVertexOutputVectors = */ 16,
-      /* .MaxFragmentInputVectors = */ 15,
-      /* .MinProgramTexelOffset = */ -8,
-      /* .MaxProgramTexelOffset = */ 7,
-      /* .MaxClipDistances = */ 8,
-      /* .MaxComputeWorkGroupCountX = */ 65535,
-      /* .MaxComputeWorkGroupCountY = */ 65535,
-      /* .MaxComputeWorkGroupCountZ = */ 65535,
-      /* .MaxComputeWorkGroupSizeX = */ 1024,
-      /* .MaxComputeWorkGroupSizeY = */ 1024,
-      /* .MaxComputeWorkGroupSizeZ = */ 64,
-      /* .MaxComputeUniformComponents = */ 1024,
-      /* .MaxComputeTextureImageUnits = */ 16,
-      /* .MaxComputeImageUniforms = */ 8,
-      /* .MaxComputeAtomicCounters = */ 8,
-      /* .MaxComputeAtomicCounterBuffers = */ 1,
-      /* .MaxVaryingComponents = */ 60,
-      /* .MaxVertexOutputComponents = */ 64,
-      /* .MaxGeometryInputComponents = */ 64,
-      /* .MaxGeometryOutputComponents = */ 128,
-      /* .MaxFragmentInputComponents = */ 128,
-      /* .MaxImageUnits = */ 8,
-      /* .MaxCombinedImageUnitsAndFragmentOutputs = */ 8,
-      /* .MaxCombinedShaderOutputResources = */ 8,
-      /* .MaxImageSamples = */ 0,
-      /* .MaxVertexImageUniforms = */ 0,
-      /* .MaxTessControlImageUniforms = */ 0,
-      /* .MaxTessEvaluationImageUniforms = */ 0,
-      /* .MaxGeometryImageUniforms = */ 0,
-      /* .MaxFragmentImageUniforms = */ 8,
-      /* .MaxCombinedImageUniforms = */ 8,
-      /* .MaxGeometryTextureImageUnits = */ 16,
-      /* .MaxGeometryOutputVertices = */ 256,
-      /* .MaxGeometryTotalOutputComponents = */ 1024,
-      /* .MaxGeometryUniformComponents = */ 1024,
-      /* .MaxGeometryVaryingComponents = */ 64,
-      /* .MaxTessControlInputComponents = */ 128,
-      /* .MaxTessControlOutputComponents = */ 128,
-      /* .MaxTessControlTextureImageUnits = */ 16,
-      /* .MaxTessControlUniformComponents = */ 1024,
-      /* .MaxTessControlTotalOutputComponents = */ 4096,
-      /* .MaxTessEvaluationInputComponents = */ 128,
-      /* .MaxTessEvaluationOutputComponents = */ 128,
-      /* .MaxTessEvaluationTextureImageUnits = */ 16,
-      /* .MaxTessEvaluationUniformComponents = */ 1024,
-      /* .MaxTessPatchComponents = */ 120,
-      /* .MaxPatchVertices = */ 32,
-      /* .MaxTessGenLevel = */ 64,
-      /* .MaxViewports = */ 16,
-      /* .MaxVertexAtomicCounters = */ 0,
-      /* .MaxTessControlAtomicCounters = */ 0,
-      /* .MaxTessEvaluationAtomicCounters = */ 0,
-      /* .MaxGeometryAtomicCounters = */ 0,
-      /* .MaxFragmentAtomicCounters = */ 8,
-      /* .MaxCombinedAtomicCounters = */ 8,
-      /* .MaxAtomicCounterBindings = */ 1,
-      /* .MaxVertexAtomicCounterBuffers = */ 0,
-      /* .MaxTessControlAtomicCounterBuffers = */ 0,
-      /* .MaxTessEvaluationAtomicCounterBuffers = */ 0,
-      /* .MaxGeometryAtomicCounterBuffers = */ 0,
-      /* .MaxFragmentAtomicCounterBuffers = */ 1,
-      /* .MaxCombinedAtomicCounterBuffers = */ 1,
-      /* .MaxAtomicCounterBufferSize = */ 16384,
-      /* .MaxTransformFeedbackBuffers = */ 4,
-      /* .MaxTransformFeedbackInterleavedComponents = */ 64,
-      /* .MaxCullDistances = */ 8,
-      /* .MaxCombinedClipAndCullDistances = */ 8,
-      /* .MaxSamples = */ 4,
-      /* .maxMeshOutputVerticesNV = */ 256,
-      /* .maxMeshOutputPrimitivesNV = */ 512,
-      /* .maxMeshWorkGroupSizeX_NV = */ 32,
-      /* .maxMeshWorkGroupSizeY_NV = */ 1,
-      /* .maxMeshWorkGroupSizeZ_NV = */ 1,
-      /* .maxTaskWorkGroupSizeX_NV = */ 32,
-      /* .maxTaskWorkGroupSizeY_NV = */ 1,
-      /* .maxTaskWorkGroupSizeZ_NV = */ 1,
-      /* .maxMeshViewCountNV = */ 4,
-      /* .maxMeshOutputVerticesEXT = */ 256,
-      /* .maxMeshOutputPrimitivesEXT = */ 256,
-      /* .maxMeshWorkGroupSizeX_EXT = */ 128,
-      /* .maxMeshWorkGroupSizeY_EXT = */ 128,
-      /* .maxMeshWorkGroupSizeZ_EXT = */ 128,
-      /* .maxTaskWorkGroupSizeX_EXT = */ 128,
-      /* .maxTaskWorkGroupSizeY_EXT = */ 128,
-      /* .maxTaskWorkGroupSizeZ_EXT = */ 128,
-      /* .maxMeshViewCountEXT = */ 4,
-      /* .maxDualSourceDrawBuffersEXT = */ 1,
-
-      /* .limits = */
-      {
-          /* .nonInductiveForLoops = */ 1,
-          /* .whileLoops = */ 1,
-          /* .doWhileLoops = */ 1,
-          /* .generalUniformIndexing = */ 1,
-          /* .generalAttributeMatrixVectorIndexing = */ 1,
-          /* .generalVaryingIndexing = */ 1,
-          /* .generalSamplerIndexing = */ 1,
-          /* .generalVariableIndexing = */ 1,
-          /* .generalConstantMatrixVectorIndexing = */ 1,
-      }};
-  return &default_resource;
+  return GetDefaultResources();
 }
 
 std::optional<SPIRV::CodeVector>
diff --git a/Source/Core/VideoCommon/Spirv.h b/Source/Core/VideoCommon/Spirv.h
index fe75ea0f99..55fe4416f3 100644
--- a/Source/Core/VideoCommon/Spirv.h
+++ b/Source/Core/VideoCommon/Spirv.h
@@ -8,7 +8,7 @@
 #include <string_view>
 #include <vector>
 
-#include "ShaderLang.h"
+#include "glslang/Public/ShaderLang.h"
 
 #include "Common/CommonTypes.h"
 #include "VideoCommon/VideoCommon.h"
-- 
2.51.0

